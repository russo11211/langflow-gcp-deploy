steps:
  # Etapa 1: Extrai o hash do commit (para tag única)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Get Commit ID'
    entrypoint: 'bash'
    args:
      - -c
      - |
        COMMIT_ID=$(git rev-parse --short HEAD || echo "local")
        echo "COMMIT_ID=$COMMIT_ID" >> /workspace/env.txt

  # Etapa 2: Build da imagem Docker
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Docker image'
    args: [
      'build',
      '-t', 'gcr.io/$PROJECT_ID/langflow:${_IMAGE_TAG}',
      '-t', 'gcr.io/$PROJECT_ID/langflow:$COMMIT_ID',
      '.'
    ]
    env:
      - 'COMMIT_ID=$(cat /workspace/env.txt | grep COMMIT_ID | cut -d= -f2)'

  # Etapa 3: Push da imagem para o Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Docker image'
    args: [
      'push', 'gcr.io/$PROJECT_ID/langflow:${_IMAGE_TAG}'
    ]

  # Etapa 4: Deploy automático no Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy to Cloud Run'
    entrypoint: 'bash'
    args:
      - -c
      - |
        echo "Deploying image gcr.io/$PROJECT_ID/langflow:${_IMAGE_TAG} to Cloud Run..."
        gcloud run deploy ${_SERVICE} \
          --image gcr.io/$PROJECT_ID/langflow:${_IMAGE_TAG} \
          --platform managed \
          --region ${_REGION} \
          --allow-unauthenticated \
          --port ${_PORT} \
          --memory ${_MEMORY} \
          --timeout 900

images:
  - 'gcr.io/$PROJECT_ID/langflow:${_IMAGE_TAG}'

substitutions:
  _IMAGE_TAG: 'latest'
  _SERVICE: 'langflow'
  _REGION: 'us-central1'
  _PORT: '7860'
  _MEMORY: '2Gi'

timeout: '2400s'
